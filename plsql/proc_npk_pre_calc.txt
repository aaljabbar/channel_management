CREATE OR REPLACE PROCEDURE MARKETFEE.NPK_PRE_CALC (I_NPK_ID NUMBER) IS 
	cnt NUMBER(5); 
	V_PERIOD VARCHAR2(6);
	V_PGL_ID NUMBER(10);
	V_METHOD VARCHAR2(3);
BEGIN 
	SELECT PERIOD, PGL_ID, METHOD INTO V_PERIOD, V_PGL_ID, V_METHOD 
	FROM NPK WHERE NPK_ID=I_NPK_ID;
	DELETE FROM NPK_PROCESS WHERE NPK_ID=I_NPK_ID AND STEP=0;
	
	commit;
	
	IF V_METHOD='BIL' 
	THEN
		-- by BILLING
		INSERT INTO NPK_PROCESS(NPK_ID, STEP, CF_ID, CF_NOM) 
        SELECT I_NPK_ID, 0, C.CF_ID, SUM(C.CF_NOM) FROM PGL_TEN A, TEN_ND B, TEN_USAGE C 
        WHERE A.TEN_ID=B.TEN_ID AND B.ND=C.ND AND C.PERIOD=V_PERIOD AND A.PGL_ID=V_PGL_ID
        GROUP BY C.CF_ID;
	ELSE
		-- by COLLECTION
		INSERT INTO NPK_PROCESS(NPK_ID, STEP, CF_ID, CF_NOM)
        SELECT I_NPK_ID, 0, C.CF_ID, SUM(C.CF_NOM) FROM PGL_TEN A, TEN_ND B, TEN_USAGE C, TEN_PAYMENT D 
        WHERE A.TEN_ID=B.TEN_ID AND B.ND=C.ND AND C.PERIOD=V_PERIOD 
        AND C.PERIOD=D.PERIOD AND C.ND=D.ND AND A.PGL_ID=V_PGL_ID AND D.IS_PAID='1'
        GROUP BY C.CF_ID;
        
    END IF;
    COMMIT;
    
    --- LIS POTS
    INSERT INTO NPK_PROCESS(NPK_ID, STEP, CF_ID, CF_NOM)    
    SELECT I_NPK_ID, 0, 28, COUNT(C.ND) FROM PGL_TEN A, TEN_ND B, TEN_PAYMENT C 
    WHERE A.TEN_ID=B.TEN_ID AND B.ND=C.ND AND C.PERIOD=V_PERIOD 
    AND B.ND=C.ND AND A.PGL_ID=V_PGL_ID AND C.ND NOT LIKE '1%'; 
    
    INSERT INTO NPK_PROCESS(NPK_ID, STEP, CF_ID, CF_NOM) 
    SELECT I_NPK_ID, 0, 77, COUNT(C.ND) FROM PGL_TEN A, TEN_ND B, TEN_PAYMENT C 
    WHERE A.TEN_ID=B.TEN_ID AND B.ND=C.ND AND C.PERIOD=V_PERIOD 
    AND B.ND=C.ND AND A.PGL_ID=V_PGL_ID AND C.ND NOT LIKE '1%' AND C.IS_PAID='1';
    
    COMMIT;
    
    --- LIS SPEEDY
    INSERT INTO NPK_PROCESS(NPK_ID, STEP, CF_ID, CF_NOM)
    SELECT I_NPK_ID, 0, 29, COUNT(C.ND) FROM PGL_TEN A, TEN_ND B, TEN_PAYMENT C 
    WHERE A.TEN_ID=B.TEN_ID AND B.ND=C.ND AND C.PERIOD=V_PERIOD 
    AND B.ND=C.ND AND A.PGL_ID=V_PGL_ID AND C.ND LIKE '1%';
    
    INSERT INTO NPK_PROCESS(NPK_ID, STEP, CF_ID, CF_NOM)
    SELECT I_NPK_ID, 0, 78, COUNT(C.ND) FROM PGL_TEN A, TEN_ND B, TEN_PAYMENT C 
    WHERE A.TEN_ID=B.TEN_ID AND B.ND=C.ND AND C.PERIOD=V_PERIOD 
    AND B.ND=C.ND AND A.PGL_ID=V_PGL_ID AND C.ND LIKE '1%' AND C.IS_PAID='1';
    
    COMMIT;

END;
/
